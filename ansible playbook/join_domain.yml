---
- hosts: all
  gather_facts: no
  tasks:
    -name: Change hostname
    win_hostname:
      name: "{{inventory_hostname_short}}"
    register: server_rename

    -name: Reboot when required
    win_reboot:
    when: server_rename.reboot_required

    -name: Join server to domain
      ansible.windows.win_domain_membership:
        dns_domain_name: ad.attackdefense.com
        domain_admin_user: Administrator
        domain_admin_password: Aa@20070173
        hostname: "{{inventory_hostname_short}}"
        stage: domain
      register: domain_join
      throttle: 1

    -name: Reboot when required
    win_reboot:
    when: server_rename.reboot_required
